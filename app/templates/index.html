{% from 'macros.html' import bootstrap_dropdown %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LLM Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
    <img src="{{ url_for('static', filename='QKSS AI LinkedIn Banner v3.png') }}" alt="QKSS AI banner" class="img-fluid mb-4" />
    <h1 class="mb-4">LLM Chat</h1>
    <form id="chat-form" class="vstack gap-3">
        <div>
            <label class="form-label">LLM</label>
            {{ bootstrap_dropdown('llm', 'Select LLM', 'bi-robot') }}
        </div>
        <div>
            <label class="form-label">Model</label>
            {{ bootstrap_dropdown('model', 'Select Model', 'bi-cpu') }}
        </div>
        <div>
            <label for="message" class="form-label">Message</label>
            <textarea id="message" name="message" rows="4" class="form-control"></textarea>
        </div>
        <div>
            <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill me-1"></i>Send</button>
        </div>
    </form>
    <div id="response" class="mt-4"></div>
    <div id="status" class="text-success"></div>
    <h2 class="mt-5">History (last 20 prompts and responses)</h2>
    <div id="history" class="vstack gap-4"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let models = {};

    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const provider = document.getElementById('llm').value;
        const model = document.getElementById('model').value;
        const messageBox = document.getElementById('message');
        const message = messageBox.value;

        // clear the textarea and show a processing indicator
        messageBox.value = '';
        messageBox.placeholder = 'Processing the message...';
        document.getElementById('status').textContent = 'Processing the message...';
        document.getElementById('response').textContent = '';

        const resp = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: 'web', provider, model_name: model, message })
        });

        const data = await resp.json();
        document.getElementById('response').innerHTML = marked.parse(data.response);
        document.getElementById('status').textContent = 'API response received.';
        messageBox.placeholder = '';
        await loadHistory();
    });

    async function loadModels() {
        const resp = await fetch('/models');
        models = await resp.json();
        const llmMenu = document.getElementById('llm-menu');
        llmMenu.innerHTML = Object.keys(models).map(m => `<li><a class="dropdown-item" href="#" data-value="${m}"><i class="bi bi-chat-square-dots me-2"></i>${m}</a></li>`).join('');
        selectItem('llm', llmMenu.querySelector('[data-value]')?.dataset.value);
    }

    function updateModelOptions() {
        const llm = document.getElementById('llm').value;
        const menu = document.getElementById('model-menu');
        const opts = models[llm] || [];
        menu.innerHTML = opts.map(m => `<li><a class="dropdown-item" href="#" data-value="${m}">${m}</a></li>`).join('');
        const first = menu.querySelector('[data-value]');
        if (first) selectItem('model', first.dataset.value, false);
    }

    function selectItem(id, value, updateModels = true) {
        if (!value) return;
        document.getElementById(id).value = value;
        document.getElementById(id + '-label').textContent = value;
        if (id === 'llm' && updateModels) updateModelOptions();
    }

    document.getElementById('llm-menu').addEventListener('click', e => {
        const item = e.target.closest('.dropdown-item');
        if (!item) return;
        e.preventDefault();
        selectItem('llm', item.dataset.value);
    });

    document.getElementById('model-menu').addEventListener('click', e => {
        const item = e.target.closest('.dropdown-item');
        if (!item) return;
        e.preventDefault();
        selectItem('model', item.dataset.value, false);
    });

    async function loadHistory() {
        const resp = await fetch('/history?session_id=web');
        const data = await resp.json();
        const html = data.history.map(pair => {
            const prompt = marked.parse(pair.prompt);
            const response = marked.parse(pair.response);
            return `<div class="border border-dark p-3 mb-3 rounded"><p><strong>User:</strong></p>${prompt}<p><strong>Assistant:</strong></p>${response}</div>`;
        }).join('');
        document.getElementById('history').innerHTML = html;
    }

    // load existing history and model list on page load
    loadModels();
    loadHistory();
</script>
</body>
</html>
