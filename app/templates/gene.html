{% from 'macros.html' import bootstrap_dropdown %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gene Variant Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
    <img src="{{ url_for('static', filename='QKSS AI LinkedIn Banner v3.png') }}" alt="QKSS AI banner" class="img-fluid mb-4" />
    <h1 class="mb-4">Gene Variant Search</h1>
    <form id="gene-form" class="vstack gap-3">
        <div>
            <label class="form-label">Who is this information for?</label>
            {{ bootstrap_dropdown('recipient', 'Select Recipient') }}
        </div>
        <div>
            <label for="gene" class="form-label">Gene</label>
            <input type="text" id="gene" name="gene" class="form-control" required />
        </div>
        <div>
            <label for="variant" class="form-label">Variant</label>
            <input type="text" id="variant" name="variant" class="form-control" required />
        </div>
        <div>
            <label class="form-label">Status</label>
            {{ bootstrap_dropdown('status', 'Select Status') }}
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>
    <div id="response" class="mt-4"></div>
    <button type="button" id="next-btn" class="btn btn-secondary mt-2" style="display:none;">Next</button>
    <div id="status-msg" class="text-success"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const statuses = ['Benign', 'Likely Benign', 'VUS', 'Likely Pathogenic', 'Pathogenic'];
    const recipients = ['self', 'child', 'spouse', 'parent'];
    const sessionId = 'gene-' + Date.now() + '-' + Math.random().toString(36).slice(2);
    let nextParams = '';

    function loadStatus() {
        const menu = document.getElementById('status-menu');
        let html = statuses.map(s => `<li><a class="dropdown-item" href="#" data-value="${s}">${s}</a></li>`).join('');
        menu.innerHTML = html;
        menu.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('status-label').textContent = a.dataset.value;
                document.getElementById('status').value = a.dataset.value;
            });
        });
    }

    function loadRecipient() {
        const menu = document.getElementById('recipient-menu');
        let html = recipients.map(r => {
            const label = r.charAt(0).toUpperCase() + r.slice(1);
            return `<li><a class="dropdown-item" href="#" data-value="${r}">${label}</a></li>`;
        }).join('');
        menu.innerHTML = html;
        menu.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('recipient-label').textContent = a.textContent;
                document.getElementById('recipient').value = a.dataset.value;
            });
        });
    }

    async function sendGeneChat() {
        const gene = document.getElementById('gene').value;
        const variant = document.getElementById('variant').value;
        const status = document.getElementById('status').value;
        const recipient = document.getElementById('recipient').value || 'self';

        nextParams = `gene=${encodeURIComponent(gene)}&variant=${encodeURIComponent(variant)}&status=${encodeURIComponent(status)}&recipient=${encodeURIComponent(recipient)}`;

        const respDiv = document.getElementById('response');
        respDiv.textContent = 'Loading...';
        try {
            const resp = await fetch('/gene_chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: sessionId,
                    gene: gene,
                    variant: variant,
                    status: status,
                    recipient: recipient,
                    provider: 'chatgpt',
                    model_name: 'gpt-3.5-turbo'
                })
            });
            const data = await resp.json();
            respDiv.innerHTML = marked.parse(data.response);
            document.getElementById('next-btn').style.display = 'block';
        } catch (err) {
            respDiv.textContent = 'Error: ' + err;
        }
        document.getElementById('status-msg').textContent = '';
    }

    document.getElementById('gene-form').addEventListener('submit', async e => {
        e.preventDefault();
        await sendGeneChat();
    });

    document.getElementById('next-btn').addEventListener('click', () => {
        window.location.href = '/conditions?' + nextParams;
    });

    loadStatus();
    loadRecipient();
</script>
</body>
</html>
