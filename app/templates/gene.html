{% from 'macros.html' import bootstrap_dropdown, bootstrap_check_dropdown %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gene Variant Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
    <img src="{{ url_for('static', filename='QKSS AI LinkedIn Banner v3.png') }}" alt="QKSS AI banner" class="img-fluid mb-4" />
    <h1 class="mb-4">Gene Variant Search</h1>
    <form id="gene-form" class="vstack gap-3">
        <div>
            <label class="form-label">Who is this information for?</label>
            {{ bootstrap_dropdown('recipient', 'Select Recipient') }}
        </div>
        <div>
            <label for="gene" class="form-label">Gene</label>
            <input type="text" id="gene" name="gene" class="form-control" required />
        </div>
        <div>
            <label for="variant" class="form-label">Variant</label>
            <input type="text" id="variant" name="variant" class="form-control" required />
        </div>
        <div>
            <label class="form-label">Status</label>
            {{ bootstrap_dropdown('status', 'Select Status') }}
        </div>
        <div>
            <label class="form-label">LLM / Model</label>
            {{ bootstrap_check_dropdown('combo', 'Select Models', 'bi-check2-square') }}
        </div>
        <div>
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>
    <div id="response" class="mt-4"></div>
    <div id="status-msg" class="text-success"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const statuses = ['Benign', 'Likely Benign', 'VUS', 'Likely Pathogenic', 'Pathogenic'];
    const recipients = ['self', 'child', 'spouse', 'parent'];
    const rolePrompts = {
        child: `You are a genetic counselor explaining genetic test results to parents about their child. Using the gene information, mutation details, and classification status provided, create a compassionate and clear summary that:
- Explains what the gene does in simple terms a parent can understand
- Describes the specific mutation found in language that avoids medical jargon
- Clearly states whether the mutation is harmful (pathogenic), not harmful (benign), or uncertain (VUS - variant of uncertain significance)
- Explains what this means for their child's health and development
- Addresses immediate parental concerns about their child's wellbeing
- Provides reassurance where appropriate while being honest about uncertainties
- Mentions next steps or recommendations for the child's care
- Uses a warm, supportive tone that acknowledges this may be overwhelming news

Focus on what parents need to know to care for their child and make informed decisions.`,
        self: `You are a genetic counselor explaining genetic test results directly to the person who received them. Using the gene information, mutation details, and classification status provided, create a clear and empowering summary that:
- Explains what the gene does and why it's important for your body
- Describes the specific genetic change that was found in straightforward language
- Clearly states whether this change is harmful (pathogenic), harmless (benign), or uncertain (VUS)
- Explains what this means for your current and future health
- Addresses how this might affect your daily life and medical care
- Discusses any preventive measures or monitoring that might be recommended
- Explains implications for family planning if relevant
- Uses a respectful, direct tone that treats you as an active participant in your healthcare
- Emphasizes your autonomy in making decisions about your health

Focus on practical information you need to understand your results and take appropriate action.`,
        spouse: `You are a genetic counselor helping someone understand their partner's genetic test results. Using the gene information, mutation details, and classification status provided, create a supportive summary that:
- Explains what the gene does and why the test was done
- Describes the genetic change found in your partner in clear, non-technical language
- States whether this mutation is harmful (pathogenic), harmless (benign), or uncertain (VUS)
- Explains what this means for your partner's health and wellbeing
- Discusses how this might affect your relationship and daily life together
- Addresses implications for any children you might have or already have
- Explains how you can be supportive while respecting your partner's autonomy
- Mentions resources available for both of you
- Uses a tone that acknowledges the emotional impact on relationships
- Respects privacy while providing information you need as a supportive partner

Focus on helping you understand how to be supportive while navigating this information together.`,
        parent: `You are a genetic counselor explaining genetic test results to an individual. Using the gene information, mutation details, and classification status provided, create a comprehensive yet accessible summary that:
- Explains what the specific gene does in your body using everyday language
- Describes the genetic variation that was found without complex scientific terms
- Clearly states the classification: harmful (pathogenic), harmless (benign), or uncertain significance (VUS)
- Explains what this result means for your health in practical terms
- Discusses any recommended medical follow-up or lifestyle considerations
- Addresses potential implications for blood relatives
- Explains the difference between having a genetic variant and actually developing symptoms
- Provides context about how common or rare this finding is
- Uses clear, respectful language that doesn't talk down to you
- Balances being thorough with being understandable

Focus on giving you the complete picture while making the information accessible and actionable.`
    };
    let models = {};

    function loadStatus() {
        const menu = document.getElementById('status-menu');
        let html = statuses.map(s => `<li><a class="dropdown-item" href="#" data-value="${s}">${s}</a></li>`).join('');
        menu.innerHTML = html;
        menu.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('status-label').textContent = a.dataset.value;
                document.getElementById('status').value = a.dataset.value;
            });
        });
    }

    function loadRecipient() {
        const menu = document.getElementById('recipient-menu');
        let html = recipients.map(r => {
            const label = r.charAt(0).toUpperCase() + r.slice(1);
            return `<li><a class="dropdown-item" href="#" data-value="${r}">${label}</a></li>`;
        }).join('');
        menu.innerHTML = html;
        menu.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('recipient-label').textContent = a.textContent;
                document.getElementById('recipient').value = a.dataset.value;
            });
        });
    }

    async function loadModels() {
        const resp = await fetch('/models');
        models = await resp.json();
        const menu = document.getElementById('combo-menu');
        let html = '';
        Object.entries(models).forEach(([provider, list]) => {
            list.forEach(info => {
                const model = typeof info === 'string' ? info : info.name;
                const id = `cmb-${provider}-${model}`.replace(/[^a-z0-9]/gi, '-');
                html += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${provider}|${model}" id="${id}"><label class="form-check-label" for="${id}">${provider} - ${model}</label></div>`;
            });
        });
        menu.innerHTML = html;
        document.getElementById('combo-label').textContent = 'Select Models';
    }

    document.getElementById('combo-menu').addEventListener('change', () => {
        const count = document.querySelectorAll('#combo-menu input:checked').length;
        document.getElementById('combo-label').textContent = count ? `${count} selected` : 'Select Models';
    });

    document.getElementById('gene-form').addEventListener('submit', async e => {
        e.preventDefault();
        const gene = document.getElementById('gene').value;
        const variant = document.getElementById('variant').value;
        const status = document.getElementById('status').value;
        const recipient = document.getElementById('recipient').value || 'self';
        const selected = Array.from(document.querySelectorAll('#combo-menu input:checked')).map(cb => cb.value.split('|'));
        const basePrompt = rolePrompts[recipient] || rolePrompts['self'];
        const prompt = `${basePrompt}\n\nGene: ${gene}\nVariant: ${variant}\nClassification Status: ${status}`;
        const respDiv = document.getElementById('response');
        respDiv.innerHTML = '';
        document.getElementById('status-msg').textContent = 'Processing...';
        for (const [provider, model] of selected) {
            const container = document.createElement('div');
            container.className = 'border p-3 mb-3 rounded';
            container.innerHTML = `<h5>${provider} - ${model}</h5><div>Loading...</div>`;
            respDiv.appendChild(container);
            try {
                const resp = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: 'gene',
                        provider: provider,
                        model_name: model,
                        message: prompt
                    })
                });
                const data = await resp.json();
                container.querySelector('div').textContent = data.response;
            } catch (err) {
                container.querySelector('div').textContent = 'Error: ' + err;
            }
        }
        document.getElementById('status-msg').textContent = 'API responses received.';
    });

    loadStatus();
    loadModels();
    loadRecipient();
</script>
</body>
</html>
